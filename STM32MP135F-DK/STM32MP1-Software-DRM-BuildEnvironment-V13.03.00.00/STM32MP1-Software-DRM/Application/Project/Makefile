###############################################################################
# Makefile for Embedded Wizard GUI Application
###############################################################################
export MAKEFLAGS += --silent

###############################################################################
# GENERAL PROJECT CONFIGURATION
###############################################################################
APP_FILE          = EmbeddedWizard-Linux-DRM

###############################################################################
# GENERAL SETTINGS & PATHS
###############################################################################
EMWI_APP_PATH     = ../GeneratedCode

SRC_PATH          = ../Source
EMWI_BSP_PATH     = ../../TargetSpecific
OBJ_PATH          = ./obj
BIN_PATH          = .

###############################################################################
# Include standard rules and utilities
# Include Embedded Wizard configuration and list of generated source code
###############################################################################
include utilities.mk
include rules.mk

ifeq (,$(wildcard $(EMWI_APP_PATH)/ewfiles.inc))
  $(error ERROR: $n$nThe file '(EMWI_APP_PATH)/ewfiles.inc' is missing!\
    $nPlease open Embedded Wizard project and generate code before calling make!)
endif

include $(EMWI_APP_PATH)/ewfiles.inc
EMWI_RTE_PATH     = ../../PlatformPackage/RTE
EMWI_GFX_PATH     = ../../PlatformPackage/$(EMWI_COLOR_FORMAT)
include $(EMWI_GFX_PATH)/ewgfx.inc
include $(EMWI_RTE_PATH)/ewrte.inc

###############################################################################
# Standard directories for C files
###############################################################################
vpath %.c           $(SRC_PATH)                                                \
                    $(EMWI_APP_PATH)                                           \
                    $(EMWI_RTE_PATH)                                           \
                    $(EMWI_GFX_PATH)                                           \
                    $(EMWI_BSP_PATH)                                           \

##############################################################################
# SOURCES
###############################################################################
APP_C =                                                                        \
                    main.c                                                     \
                    ewmain.c                                                   \
                    gfx_system_drm.c                                           \
                    DeviceDriver.c                                             \

# automatically compile all files generated by Embedded Wizard
APP_EMWI_C =        $(EMWIFILES)

# compile all files for the Embedded Wizard Runtime Environment (RTE)
RTE_EMWI_C =        $(EMWI_RTE_FILES)

# compile all files for the Embedded Wizard Graphics Engine (GFX)
GFX_EMWI_C =        $(EMWI_GFX_FILES)

BSP_EMWI_C =                                                                   \
                    ew_bsp_display.c                                           \
                    ew_bsp_touch.c                                             \
                    ew_bsp_console.c                                           \
                    ew_bsp_os.c                                                \

###############################################################################
# LIBRARIES
###############################################################################
LIBS :=             m                                                          \
                    pthread                                                    \
                    drm                                                        \
                    $(EMWI_GFX_LIB)                                            \
                    $(EMWI_RTE_LIB)                                            \

###############################################################################
# INCLUDES
###############################################################################
INCLUDES =                                                                     \
                    -I$(SRC_PATH)                                              \
                    -I$(EMWI_APP_PATH)                                         \
                    -I$(EMWI_RTE_PATH)                                         \
                    -I$(EMWI_GFX_PATH)                                         \
                    -I$(EMWI_BSP_PATH)                                         \
                    -I$(SYSROOT)/usr/include                                   \
                    -I$(SYSROOT)/usr/include/drm                               \
                    -I$(SYSROOT)/usr/include/libdrm                            \

###############################################################################
# DEFINES
###############################################################################
CFLAGS =            -O2 -Wall                                                  \
                    -DEW_USE_OPERATING_SYSTEM=1                                \
                    -DEW_FRAME_BUFFER_COLOR_FORMAT=EW_FRAME_BUFFER_COLOR_FORMAT_$(EMWI_COLOR_FORMAT) \
                    -DEW_SURFACE_ROTATION=$(EMWI_SURFACE_ROTATION)             \

###############################################################################
# OBJECTS
###############################################################################
APP_OBJ         := $(foreach file,$(APP_C),      $(OBJ_PATH)/$(strip $(basename $(file))).o)
APP_EMWI_OBJ    := $(foreach file,$(APP_EMWI_C), $(OBJ_PATH)/$(strip $(basename $(file))).o)
RTE_EMWI_OBJ    := $(foreach file,$(RTE_EMWI_C), $(OBJ_PATH)/$(strip $(basename $(file))).o)
GFX_EMWI_OBJ    := $(foreach file,$(GFX_EMWI_C), $(OBJ_PATH)/$(strip $(basename $(file))).o)
BSP_EMWI_OBJ    := $(foreach file,$(BSP_EMWI_C), $(OBJ_PATH)/$(strip $(basename $(file))).o)

OBJS := $(APP_OBJ) $(APP_EMWI_OBJ) $(RTE_EMWI_OBJ) $(GFX_EMWI_OBJ) $(BSP_EMWI_OBJ)

LINKING   = $(CC) $(OBJS)                                                      \
            $(addprefix -L,$(EMWI_RTE_PATH))                                   \
            $(addprefix -L,$(EMWI_GFX_PATH))                                   \
            $(addprefix -l,$(LIBS))                                            \
            -o $(BIN_PATH)/$(APP_FILE)

###############################################################################
# RULES
###############################################################################
$(APP_FILE): precompile $(OBJS)
	@echo Linking $(APP_FILE)
	@echo $(LINKING)
	$(LINKING)
	@echo $(APP_FILE) successfully built !!

install:$(APP_FILE)
	-./run_on_target.sh $(APP_FILE)

projectecho:
	@echo -------------------------------------------------
	@echo Creating $(APP_FILE)
	@echo -------------------------------------------------
	@echo Compiler Options: $(CCRUN_STD)

createdirs:
	@echo -------------------------------------------------
	@echo Creating object and library directories
	-$(MKDIR) $(OBJ_PATH)
	@echo -------------------------------------------------

precompile: projectecho createdirs ;

.PHONY: clean
clean:
	@echo Cleaning $(OBJ_PATH) and lib$(LIB_FILE)
	-$(RMDIR) $(OBJ_PATH)
	-$(RM) lib$(LIB_FILE).*

include $(wildcard $(patsubst %,%.d,$(basename $(OBJS))))
